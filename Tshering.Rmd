---
title: "Data Pre-Processing"
output: html_document
---

```{r setup, include=FALSE}
#knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(readxl)
library(caret)
library(tidyverse)         # for graphing and data cleaning
library(tidymodels)        # for modeling
library(themis)            # for step functions for unbalanced data
library(doParallel)        # for parallel processing
library(stacks)            # for stacking models
library(naniar)            # for examining missing values (NAs)
library(lubridate)         # for date manipulation
library(moderndive)        # for King County housing data
library(vip)               # for variable importance plots
library(patchwork)         # for combining plots nicely
library(xgboost)
theme_set(theme_minimal()) # Lisa's favorite theme
```


```{r}
ADS_Project_11_29_2021_v8 <- read_excel("ADS_Project - 11.29.2021.v8.xlsx")
```

### Data Preprocessing 

```{r}
Master <- ADS_Project_11_29_2021_v8 %>%
select(-c(`Last Calculated EOD metrics (time, in seconds)`, `Block Count`, `Block Size (mean, in bytes)`, `Block Weight, (mean`, `Capitalization of current supply, MVRV`, `Capitalization of free float, MVRV`, `Difficulty, Last Block`, `Difficulty, Mean Block`, `Mean Transaction Fee per Byte of all blocks, native units`, `Mean Transaction Fee per Byte, native units`, `Median Transaction Fee, native units`, `Median Fee per Transacation, USD`, `Addresses balance greater than 0.001 native units`, `Addresses balance greater than 0.01 native units`, `Addresses balance greater than 0.1 native units`,`Addresses balance greater than 100 native units`, `Addresses balance greater than 100K native units`, `Addresses balance greater than 10 native units`, `Addresses balance greater than 10K native units`, `Addresses balance greater than 1 native units`, `Addresses balance greater than 1K native units`, `Addresses balance greater than 1M native units`, `Addresses balance greater than 1in100K`, `Addresses balance greater than 1in100M`, `Addresses balance greater than 1in10B`, `Addresses balance greater than 1in10K`, `Addresses balance greater than 1in10K`, `Addresses balance greater than 1in10M`, `Addresses balance greater than 1in1B`, `Addresses balance greater than 1in1K`, `Addressesbalance greater than 1in1M`, `Total Fees, native units`, `Flow to exchanges, native units`, `Flow out exchanges, native units`, `Gas Limit Block`, `Gas Limit, transaction`, `Gas Used, transaction`, `Hash Rate Mean, 30d`, `Issuance, native units`, `Issuance, percent annualized`, `Issuance,  percent daily`, `Issuance Total, native units`,`NVT, adjusted, 90d MA`, `NVT, adjusted, free float,  90d MA`, `ROI, 1y (%)`, `Revenue, per hash unit (Native Currency)`, `Revenue Daily, per hash unit/second (Native Currency)`, `Miner Rev (Native Currency)`, `Supply, 10y Active`, `Supply, 5yr Active`, `Supply, 4yr Active`, `Supply, 3yr Active`, `Supply, 1yr Active Trailing (%)`, `Supply, in addresses (<0.001, native currency)`, `Supply, in addresses (<0.01M, native currency)`, `Supply, in addresses (<0.1, native currency)`, `Supply, in addresses (<1, native currency)`, `Supply, in addresses (<10, native currency)`, `Supply, in addresses (<100, native currency)`, `Supply, in addresses (<100K, native currency)`, `Supply, in addresses (<10K, native currency)`, `Supply, in addresses (<1K, native currency)`, `Supply, in addresses (<1M, native currency)`, `Supply, Miner address with 1 mining entity (native currency)`, `Supply, All Miners (native currency)`, `Transactions, adjusted transfer value (native currency)`, `Transactions, mean transfer value (native currency)`, `Transactions, median transfer value (native currency)`, `Transactions, mean transfer value ($)`, `Transactions, median transfer value (native currency)`, `Velocity, 1yr current supply`, `Volatility, 180d daily returns`, `Volatility, 30d daily returns`, `Price, BTC`, `Price, ($)`, `Transactions, median transfer value ($)`))
```

```{r}
Master <- Master %>% rename(AddressCount = `Addresses Active Count`,
                  AddressCount100K = `Addresses balance greater than $100K`,
                  AddressCount10M = `Addresses balance greater than $10M`,
                  TotalBlockWeight = `Block, weight, total`,
                  MarketCapitalizationSupply = `Capitalization of Current Supply, in USD`,
                  TransactionFee = `Mean Fee per Transaction, USD`,
                  TransactionGas = `Mean Gas Used, transaction`,
                  BlockGas = `Gas Limit Block, mean`,
                  HashRate = `Hash Rate, mean`,
                  NetworkDF = `Network distribution factor`,
                  HashRevenue = `Revenue, per hash unit ($)`,
                  Supply = `Supply, Total Active`,
                  TransactionsCount = `Transactions, count`)
```

```{r}
Master %>% mutate(Date = ymd(Date)) %>%
           
```

### Train the model

```{r}
Master_Split <- initial_split(Master, prop = 0.75)

Master_Training <- training(Master_Split)
Master_Testing <- testing(Master_Split)
```

### Lasso Model - Classification

```{r}
set.seed(456)

lasso_recipe <- 
  recipe(Price~.,
         data = Master_Training) %>%
         step_mutate_at(all_numeric(), -all_outcomes(), fn= ~ as.numeric(.)) %>%
         step_dummy(all_nominal(), -all_outcomes()) %>%
         step_normalize(all_predictors(),
                 -all_nominal(),
                 -has_role(match = 'evaluative'))

lasso_recipe %>%
  prep() %>%
  juice()
```

```{r}
lasso_model <- 
  logistic_reg(mixture = 1) %>%
  set_engine("glmnet") %>%
  set_args(penalty = tune()) %>%
  set_mode("classification")

lasso_wf <- workflow() %>%
            add_recipe(lasso_recipe) %>%
            add_model(lasso_model)
```

```{r}
set.seed(456)

Bitcoin_cv <- vfold_cv(Master_Training,v = 5)
penalty_grid <- grid_regular(penalty(), levels = 10)
ctrl_grid <- control_stack_resamples()

metric <- metric_set(accuracy)
```

```{r}
lasso_tune <- 
  lasso_wf %>% 
  tune_grid(
    resamples = Bitcoin_cv,
    grid = penalty_grid,
    control = ctrl_grid
  )

lasso_tune %>% collect_metrics()
```

